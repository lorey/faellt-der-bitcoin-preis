<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fällt der Bitcoin-Preis gerade?</title>
    <style>
        body {
            color: white;
            background-color: #777;
            font-family: sans-serif;
            text-align: center;
            margin-top: 100px;
        }

        h3 {
            margin-top: 100px;
        }
    </style>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
</head>
<body>
<h1>Fällt der Bitcoin-Preis gerade?</h1>
<h2>In wenigen Sekunden wirst du es wissen...</h2>
<p>
    Als du diese Seite geladen hast war der Preis <span id="startingprice"></span>€.<br>
    Der aktuelle Preis ist <span id="price"></span>€.<br>
    Der Preis ist also um <span id="pricedeltapercentage">0</span>% bzw. <span id="pricedelta"></span>€ <span id="pricedeltaword">gefallen</span>.
</p>
<p>
    Hättest du beim Laden der Seite 1000€ in Bitcoin gewechselt, hättest du jetzt <span id="investmentnow">1000€</span>.
</p>
<h3>Der Bitcoin-Preis in den letzten 24h</h3>
<img src="https://bitcoinity.org/markets/image?span=24h&size=medium&currency=EUR&exchange=coinbase">

<h3>Feedback/Verbesserungen</h3>
<p style="font-size: 75%">
    Dieses Projekt ist auf GitHub unter <a href="https://github.com/lorey/faellt-der-bitcoin-preis" target="_blank">lorey/faellt-der-bitcoin-preis</a>.<br>
    <a href="https://twitter.com/karllorey" target="_blank">Karl Lorey</a> ist auf Twitter.<br>
    Mit Liebe in der <a href="http://startup-karlsruhe.de" target="_blank">Startup-Stadt Karlsruhe</a> gemacht.
</p>

<script>
    var priceCurrentTag = document.querySelector("#price");
    var priceStartTag = document.querySelector("#startingprice");
    var headingTag = document.querySelector("h2");
    var priceDeltaTag = document.querySelector("#pricedelta");
    var priceDeltaPercentageTag = document.querySelector("#pricedeltapercentage");
    var priceDeltaWordTag = document.querySelector("#pricedeltaword");
    var investmentNowTag = document.querySelector('#investmentnow');

    var priceStart = null;
    var priceCurrent = null;
    var deltaPercentage = null;

    function fillPrice(data) {
        var rate = data.bpi.EUR.rate_float;

        if (priceStart === null) {
            priceStart = rate;
            priceStartTag.innerHTML = Math.round(priceStart);
        }

        priceCurrent = rate;

        var priceDelta = priceCurrent - priceStart;
        var deltaRatio = priceCurrent / priceStart;
        var investmentNow = 1000 * deltaRatio;

        priceCurrentTag.innerHTML = Math.round(priceCurrent);
        priceDeltaTag.innerHTML = Math.round(Math.abs(priceDelta));
        investmentNowTag.innerHTML = Math.round(investmentNow) + '€';

        var deltaRatioReadable = (1 - deltaRatio);
        deltaPercentage = Math.abs(100 * deltaRatioReadable);
        priceDeltaPercentageTag.innerHTML = "" + Math.round(100 * deltaPercentage) / 100;

        if (priceCurrent < priceStart) {
            // heißßß
            headingTag.innerHTML = "Ja, der Bitcoin-Preis fällt gerade";
            document.body.style.backgroundColor = '#C92E12';
            priceDeltaWordTag.innerHTML = 'gefallen';
            document.title = '⬇ Bitcoin️ fällt';
        } else if(priceCurrent > priceStart) {
            // kaltttt
            headingTag.innerHTML = "Nein, der Bitcoin-Preis fällt gerade nicht";
            document.body.style.backgroundColor = '#829A60';
            priceDeltaWordTag.innerHTML = 'gestiegen';
            document.title = '️⬆ Bitcoin steigt️';
        }
    }

    var refreshPrice = function(){
        //make the request
        $.ajax({
            method: "GET",
            url: 'https://api.coindesk.com/v1/bpi/currentprice.json',
            dataType: 'json'
        })
        .done(fillPrice);
    };

    refreshPrice();
    setInterval(refreshPrice, 1000);

    setInterval(function () {
        // reload image regularly: https://stackoverflow.com/a/1077051
        document.querySelector('img').src = 'https://bitcoinity.org/markets/image?span=24h&size=medium&currency=EUR&exchange=coinbase&' + new Date().getTime();
    }, 60000);
</script>

</body>
</html>
